{% extends "base.html" %}
{% load fleet_filters %}

{% block title %}{{ module.module_id }} - Detalle Mant. Medio / Pesado{% endblock %}

{% block content %}
<div x-data="{ showObsModal: false, obsText: '' }">

    <!-- Back + Module Selector -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
        <div class="flex items-center space-x-4">
            <a href="{% url 'fleet:module_list' %}" 
               class="text-ta-500 hover:text-ta-700 transition-colors flex items-center space-x-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                <span class="text-base font-medium">Volver a Flota</span>
            </a>
            <h1 class="text-4xl font-bold text-ta-700">{{ module.module_id }}</h1>
            <span class="{% if module.fleet_type == 'CSR' %}badge-csr{% else %}badge-toshiba{% endif %}">
                {{ module.fleet_type }}
            </span>
            <!-- Data Source Indicator -->
            <span class="px-2 py-0.5 text-sm font-semibold rounded {% if data_source == 'ACCESS' %}bg-blue-100 text-blue-800{% else %}bg-gray-200 text-gray-600{% endif %}">
                {{ data_source }}
            </span>
        </div>

        <!-- Module Selector Dropdown -->
        <div class="flex items-center space-x-2">
            <label for="module-selector" class="text-base text-gray-600 font-medium">Ir a módulo:</label>
            <select id="module-selector" 
                    onchange="if(this.value) window.location.href=this.value"
                    class="border border-ta-200 rounded-lg px-3 py-2 text-base bg-white focus:ring-2 focus:ring-ta-400 focus:border-ta-400">
                <option value="">Seleccionar...</option>
                {% for opt in module_options %}
                <option value="{% url 'fleet:module_detail' opt.id %}" 
                        {% if opt.id == current_module_id %}selected{% endif %}>
                    {{ opt.label }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Module Header Card -->
    <div class="bg-white rounded-xl shadow-md border-l-4 {% if module.fleet_type == 'CSR' %}border-l-green-500{% else %}border-l-yellow-500{% endif %} border border-gray-100 p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Basic Info -->
            <div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Información General</h2>
                <dl class="space-y-1 text-base">
                    <div>
                        <dt class="text-gray-500 text-sm">Configuración</dt>
                        <dd class="font-medium text-gray-900">{{ module.configuration|title }} ({{ module.coach_count }}c)</dd>
                    </div>
                    {% if module.coaches %}
                    <div>
                        <dt class="text-gray-500 text-sm">Composición</dt>
                        <dd class="font-medium text-gray-700 text-sm leading-relaxed">
                            {% for coach in module.coaches %}{{ coach.coach_type }}-{{ coach.number }}{% if not forloop.last %} | {% endif %}{% endfor %}
                        </dd>
                    </div>
                    {% endif %}
                    {% if module.reference_date %}
                    <div>
                        <dt class="text-gray-500 text-sm">{{ module.reference_type }}</dt>
                        <dd class="font-medium text-gray-900">{{ module.reference_date|date:"d/m/Y" }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- KM Data -->
            <div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Kilometraje</h2>
                <dl class="space-y-1 text-base">
                    <div>
                        <dt class="text-gray-500 text-sm">KM Total</dt>
                        <dd class="font-bold text-gray-900 text-xl">{{ module.km_total_accumulated|euro_number }}</dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 text-sm">KM Mes{% if module.km_current_month_label %} ({{ module.km_current_month_label }}){% endif %}</dt>
                        <dd class="font-medium text-gray-900">{{ module.km_current_month|euro_number }}</dd>
                    </div>
                    {% if module.fleet_type == 'Toshiba' and module.km_since_rg is not None %}
                    <div>
                        <dt class="text-gray-500 text-sm">KM desde RG</dt>
                        <dd class="font-bold {% if module.km_since_rg > 500000 %}text-red-600{% elif module.km_since_rg > 400000 %}text-orange-500{% elif module.km_since_rg > 300000 %}text-yellow-600{% else %}text-green-600{% endif %}">
                            {{ module.km_since_rg|euro_number }}
                        </dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- Last Maintenance -->
            <div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Último Mantenimiento</h2>
                <dl class="space-y-1 text-base">
                    <div>
                        <dt class="text-gray-500 text-sm">Tipo</dt>
                        <dd><span class="font-medium px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-sm">{{ module.last_maintenance_type }}</span></dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 text-sm">Fecha</dt>
                        <dd class="font-medium text-gray-900">{{ module.last_maintenance_date|date:"d/m/Y" }}</dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 text-sm">KM desde mant.</dt>
                        <dd class="font-medium {% if module.km_since_maintenance > 50000 %}text-red-600{% elif module.km_since_maintenance > 30000 %}text-yellow-600{% else %}text-green-600{% endif %}">
                            {{ module.km_since_maintenance|euro_number }}
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- Projection -->
            <div>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Próxima Intervención</h2>
                {% if projection %}
                <dl class="space-y-1 text-base">
                    <div>
                        <dt class="text-gray-500 text-sm">Tipo</dt>
                        <dd><span class="font-medium px-2 py-0.5 bg-amber-100 text-amber-800 rounded text-sm">{{ projection.cycle_label }}</span></dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 text-sm">KM restantes</dt>
                        <dd class="font-bold {% if projection.km_remaining < 10000 %}text-red-600{% elif projection.km_remaining < 50000 %}text-orange-500{% else %}text-green-600{% endif %}">
                            {{ projection.km_remaining|euro_number }}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 text-sm">Fecha estimada</dt>
                        <dd class="font-medium text-gray-900">{{ projection.estimated_date|date:"d/m/Y" }}</dd>
                    </div>
                </dl>
                {% else %}
                <p class="text-base text-gray-400 italic">Sin datos para proyección</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Section: Detalle Mantenimiento Pesado -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 mb-6">
        <h2 class="text-2xl font-bold text-ta-700 mb-4">Detalle Mantenimiento Pesado</h2>
        <p class="text-base text-gray-500 mb-4">
            Última intervención de cada tipo del ciclo de mantenimiento 
            {% if module.fleet_type == 'CSR' %}(CSR: AN / BA / PE / DA){% else %}(Toshiba: RB / RG){% endif %}
        </p>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Tipo de Intervención</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Ciclo (km)</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Última Fecha</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">KM en esa Fecha</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">KM desde entonces</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">% Ciclo</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for kd in module.maintenance_key_data %}
                    {# Filter to show only heavy cycles: CSR=AN,BA,PE,DA | Toshiba=RB,RG #}
                    {% if module.fleet_type == 'CSR' and kd.cycle_type in 'AN,BA,PE,DA' or module.fleet_type == 'Toshiba' and kd.cycle_type in 'RB,RG' %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 text-base font-medium text-gray-900">
                            {{ kd.cycle_label }}
                            {% if kd.inherited_from %}
                            <span class="ml-1 text-xs text-gray-400" title="Heredado de {{ kd.inherited_from }}">*</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-gray-600">{{ kd.cycle_km|euro_number }}</td>
                        <td class="px-4 py-3 text-base text-gray-600">
                            {% if kd.last_date %}
                                {{ kd.last_date|date:"d/m/Y" }}
                                {% if kd.inherited_from %}
                                <span class="ml-1 text-xs text-amber-600" title="Fecha heredada de {{ kd.inherited_from }}">({{ kd.inherited_from }})</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400 italic">Sin datos</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-right text-gray-600">
                            {% if kd.km_at_last is not None %}{{ kd.km_at_last|euro_number }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-right font-semibold
                            {% if kd.km_since is not None and kd.km_since > kd.cycle_km %}text-red-600{% else %}text-gray-900{% endif %}
                        ">
                            {% if kd.km_since is not None %}{{ kd.km_since|euro_number }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-right">
                            {% if kd.km_since is not None and kd.cycle_km > 0 %}
                                {% widthratio kd.km_since kd.cycle_km 100 as pct %}
                                <div class="flex items-center justify-end space-x-2">
                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full {% if pct > 90 %}bg-red-500{% elif pct > 70 %}bg-orange-400{% elif pct > 50 %}bg-yellow-400{% else %}bg-green-500{% endif %}"
                                             style="width: {% if pct > 100 %}100{% else %}{{ pct }}{% endif %}%"></div>
                                    </div>
                                     <span class="text-sm font-medium {% if pct > 90 %}text-red-600{% elif pct > 70 %}text-orange-500{% else %}text-gray-600{% endif %}">{{ pct }}%</span>
                                </div>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-400 italic text-base">
                            No hay datos de mantenimiento disponibles para este módulo.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if module.maintenance_key_data %}
        <p class="text-xs text-gray-400 mt-3">
            * Los ciclos marcados heredan fecha/km de una intervención de mayor jerarquía.
        </p>
        {% endif %}
    </div>

    <!-- Section: Historial de Mantenimientos (Último Año) -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
        <h2 class="text-2xl font-bold text-ta-700 mb-4">Historial de Mantenimientos (Último Año)</h2>
        <p class="text-base text-gray-500 mb-4">
            Listado de todas las intervenciones realizadas en los últimos 365 días, ordenadas por fecha.
        </p>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Fecha Inicio</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Fecha Fin</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">Días</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">OT SIMAF</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                        <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">Kilometraje</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for event in module.maintenance_history %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 text-base text-gray-600">
                            {% if event.start_date %}{{ event.start_date|date:"d/m/Y" }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-gray-600">
                            {% if event.end_date %}{{ event.end_date|date:"d/m/Y" }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-right text-gray-900 font-medium">
                            {% if event.duration_days is not None %}{{ event.duration_days }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3 text-base text-gray-600">
                            {% if event.ot_simaf %}{{ event.ot_simaf }}{% else %}-{% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm font-medium px-2 py-0.5 bg-blue-100 text-blue-800 rounded">{{ event.task_type }}</span>
                        </td>
                        <td class="px-4 py-3 text-base text-right text-gray-900 font-medium">{{ event.km_at_event|euro_number }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-400 italic text-base">
                            No hay registros de mantenimiento en el último año.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}
