{% extends "base.html" %}
{% load fleet_filters %}

{% block title %}Man. Planner - {{ fleet_type }}{% endblock %}

{% block content %}
<div x-data="projectionGrid()" x-init="init()">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-ta-700">Maintenance Planner</h1>
            <p class="text-sm text-ta-400">Proyeccion de mantenimiento pesado - Linea Roca</p>
        </div>
        <a href="{% url 'fleet:module_list' %}"
           class="text-sm text-ta-500 hover:text-ta-700 transition-colors">
            &larr; Volver a Flota
        </a>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <form method="get" action="{% url 'fleet:projection_grid' %}" class="flex flex-wrap items-end gap-4">

            <!-- Fleet selector - uses links instead of submit buttons to avoid hidden field conflict -->
            <div>
                <label class="block text-xs text-gray-500 mb-1">Flota</label>
                <div class="flex rounded-lg overflow-hidden border border-gray-300">
                    <a href="{% url 'fleet:projection_grid' %}?fleet=csr&months={{ months }}&avg_km={{ avg_km }}"
                        class="px-4 py-2 text-sm font-medium transition-colors
                               {% if fleet_param == 'csr' %}bg-green-600 text-white{% else %}bg-white text-gray-600 hover:bg-green-50{% endif %}">
                        CSR
                    </a>
                    <a href="{% url 'fleet:projection_grid' %}?fleet=toshiba&months={{ months }}&avg_km={{ avg_km_toshiba }}"
                        class="px-4 py-2 text-sm font-medium transition-colors border-l border-gray-300
                               {% if fleet_param == 'toshiba' %}bg-yellow-500 text-white{% else %}bg-white text-gray-600 hover:bg-yellow-50{% endif %}">
                        Toshiba
                    </a>
                </div>
            </div>

            <!-- Months -->
            <div>
                <label for="months" class="block text-xs text-gray-500 mb-1">Meses</label>
                <input type="number" name="months" id="months" value="{{ months }}"
                       min="1" max="60"
                       class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-ta-500 focus:border-ta-500">
            </div>

            <!-- Avg KM -->
            <div>
                <label for="avg_km" class="block text-xs text-gray-500 mb-1">KM Prom. Mensual</label>
                <input type="number" name="avg_km" id="avg_km" value="{{ avg_km }}"
                       min="1000" step="500"
                       class="w-28 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-ta-500 focus:border-ta-500">
            </div>

            <!-- Hidden fleet for months/avg_km submit -->
            <input type="hidden" name="fleet" value="{{ fleet_param }}">

            <!-- Generate -->
            <button type="submit"
                    class="px-4 py-2 bg-ta-600 text-white rounded-lg hover:bg-ta-700 transition-colors text-sm font-medium">
                Generar Proyeccion
            </button>

            <!-- Export -->
            <button type="button" @click="exportExcel()"
                    class="px-4 py-2 bg-white text-ta-600 border border-ta-300 rounded-lg hover:bg-ta-50 transition-colors text-sm font-medium">
                Exportar a Excel
            </button>
        </form>
    </div>

    <!-- Grid Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full text-xs">
                <!-- Header -->
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <th class="sticky left-0 z-20 bg-gray-50 px-3 py-2 text-left font-semibold text-gray-700 border-b border-r border-gray-200 min-w-[80px]">
                            Modulo
                        </th>
                        <th class="sticky left-[80px] z-20 bg-gray-50 px-2 py-2 text-center font-semibold text-gray-700 border-b border-r border-gray-200 min-w-[80px]">
                            Fecha
                        </th>
                        <th class="sticky left-[160px] z-20 bg-gray-50 px-3 py-2 text-left font-semibold text-gray-700 border-b border-r border-gray-200 min-w-[60px]">
                            Ciclo
                        </th>
                        <th class="sticky left-[220px] z-20 bg-gray-50 px-2 py-2 text-right font-semibold text-gray-700 border-b border-r border-gray-200 min-w-[70px]">
                            Umbral
                        </th>
                        {% for header in month_headers %}
                        <th class="px-2 py-2 text-center font-medium text-gray-600 border-b border-gray-200 min-w-[80px] whitespace-nowrap">
                            {{ header }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for module in grid %}
                        {% for row in module.cycle_rows %}
                        <tr class="{% if forloop.parentloop.counter|divisibleby:2 %}bg-gray-50{% endif %} hover:bg-blue-50/30 transition-colors"
                            data-module="{{ module.module_id }}"
                            data-cycle="{{ row.cycle_type }}">

                            <!-- Module ID (only on first cycle row) -->
                            {% if forloop.first %}
                            <td class="sticky left-0 z-10 px-3 py-1.5 font-bold text-gray-900 border-b border-r border-gray-200 {% if forloop.parentloop.counter|divisibleby:2 %}bg-gray-100{% else %}bg-white{% endif %}"
                                rowspan="{{ module.cycle_rows|length }}">
                                {{ module.module_id }}
                            </td>
                            {% endif %}

                            <!-- Last intervention date -->
                            <td class="sticky left-[80px] z-10 px-2 py-1.5 text-center text-[10px] text-gray-500 border-b border-r border-gray-200 whitespace-nowrap {% if forloop.parentloop.counter|divisibleby:2 %}bg-gray-100{% else %}bg-white{% endif %}">
                                {% if row.last_date %}{{ row.last_date|date:"d/m/Y" }}{% else %}-{% endif %}
                            </td>

                            <!-- Cycle type badge -->
                            <td class="sticky left-[160px] z-10 px-3 py-1.5 border-b border-r border-gray-200 {% if forloop.parentloop.counter|divisibleby:2 %}bg-gray-100{% else %}bg-white{% endif %}">
                                <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold {{ row.color_bg }} {{ row.color_text }}">
                                    {{ row.cycle_type }}
                                </span>
                            </td>

                            <!-- Threshold -->
                            <td class="sticky left-[220px] z-10 px-2 py-1.5 text-right text-gray-500 border-b border-r border-gray-200 {% if forloop.parentloop.counter|divisibleby:2 %}bg-gray-100{% else %}bg-white{% endif %}">
                                {{ row.cycle_km|euro_number }}
                            </td>

                            <!-- Month cells -->
                            {% for cell in row.months %}
                            <td class="px-2 py-1.5 text-right border-b border-gray-100 cursor-pointer select-none whitespace-nowrap
                                       {% if cell.exceeded %}{{ row.color_bg }} {{ row.color_text }} font-semibold{% else %}text-gray-600{% endif %}"
                                data-module-id="{{ module.module_id }}"
                                data-cycle-type="{{ row.cycle_type }}"
                                data-month-idx="{{ forloop.counter0 }}"
                                data-original-km="{{ cell.km_accumulated }}"
                                data-threshold="{{ row.cycle_km }}"
                                data-exceeded="{{ cell.exceeded|yesno:'true,false' }}"
                                data-original-class="px-2 py-1.5 text-right border-b border-gray-100 cursor-pointer select-none whitespace-nowrap {% if cell.exceeded %}{{ row.color_bg }} {{ row.color_text }} font-semibold{% else %}text-gray-600{% endif %}"
                                @dblclick="handleDblClick($event, '{{ module.module_id }}', '{{ row.cycle_type }}', {{ forloop.counter0 }}, {{ cell.km_accumulated }})">
                                <span class="cell-value">{{ cell.km_accumulated|euro_number }}</span>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    {% empty %}
                        <tr>
                            <td colspan="{{ month_headers|length|add:4 }}" class="text-center py-8 text-gray-400">
                                No hay datos disponibles para esta flota.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
                <!-- Summary footer: count of interventions per cycle per month (updated dynamically by Alpine.js) -->
                <tfoot class="border-t-2 border-gray-300" id="summary-footer">
                    {% for sr in summary_cycles %}
                    <tr class="bg-gray-50">
                        <td colspan="3" class="sticky left-0 z-10 bg-gray-50 px-3 py-1.5 border-b border-r border-gray-200">
                            <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold {{ sr.color_bg }} {{ sr.color_text }}">
                                {{ sr.cycle_type }}
                            </span>
                        </td>
                        <td class="sticky left-[220px] z-10 bg-gray-50 px-2 py-1.5 text-right text-gray-400 text-[10px] border-b border-r border-gray-200">
                        </td>
                        {% for header in month_headers %}
                        <td class="px-2 py-1.5 text-center border-b border-gray-100 text-gray-700 font-semibold"
                            data-summary-cycle="{{ sr.cycle_type }}"
                            data-summary-month="{{ forloop.counter0 }}">
                            <span class="summary-value">0</span>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    <!-- Control row: total interventions per month -->
                    <tr class="bg-gray-100 font-bold">
                        <td colspan="3" class="sticky left-0 z-10 bg-gray-100 px-3 py-1.5 border-b border-r border-gray-200 text-gray-700 text-xs">
                            Control
                        </td>
                        <td class="sticky left-[220px] z-10 bg-gray-100 px-2 py-1.5 text-right text-gray-400 text-[10px] border-b border-r border-gray-200">
                        </td>
                        {% for header in month_headers %}
                        <td class="px-2 py-1.5 text-center border-b border-gray-100 text-gray-900"
                            data-summary-cycle="TOTAL"
                            data-summary-month="{{ forloop.counter0 }}">
                            <span class="summary-value">0</span>
                        </td>
                        {% endfor %}
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Legend -->
    <div class="mt-4 flex flex-wrap gap-4 text-xs text-gray-500">
        <span class="font-medium">Tipo Intervencion:</span>
        {% if fleet_param == 'csr' %}
        <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-100 border border-green-300"></span> AN ({{ "187500"|euro_number }} km)</span>
        <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-yellow-100 border border-yellow-300"></span> BA ({{ "375000"|euro_number }} km)</span>
        <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-sky-100 border border-sky-300"></span> PE ({{ "750000"|euro_number }} km)</span>
        <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-100 border border-red-300"></span> DA ({{ "1500000"|euro_number }} km)</span>
        {% else %}
        <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-yellow-100 border border-yellow-300"></span> RB ({{ "300000"|euro_number }} km)</span>
        <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-100 border border-red-300"></span> RG ({{ "600000"|euro_number }} km)</span>
        {% endif %}
        <span class="ml-4 text-gray-400">Doble click en celda para marcar intervencion</span>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function projectionGrid() {
    return {
        // Track user interventions: { "M01-AN-3": true }  (module-cycle-monthIdx)
        interventions: {},

        // Hierarchy definitions (higher resets lower)
        hierarchyCSR: ['DA', 'PE', 'BA', 'AN'],
        hierarchyToshiba: ['RG', 'RB'],

        // Cycle colors for intervention marking (matching the badge colors)
        cycleColors: {
            'DA': { bg: 'bg-red-100', text: 'text-red-800' },
            'PE': { bg: 'bg-sky-100', text: 'text-sky-800' },
            'BA': { bg: 'bg-yellow-100', text: 'text-yellow-800' },
            'AN': { bg: 'bg-green-100', text: 'text-green-800' },
            'RG': { bg: 'bg-red-100', text: 'text-red-800' },
            'RB': { bg: 'bg-yellow-100', text: 'text-yellow-800' },
        },

        // Number of month columns for summary iteration
        totalMonths: {{ months }},

        init() {
            // Initial summary is all zeros (no interventions marked yet)
        },

        /**
         * Handle double-click on a cell to toggle intervention mark.
         * When marked: shows cycle type code (e.g. "AN"), resets km.
         * When unmarked: restores original km value.
         * Hierarchy: marking a cycle resets all lower cycles at that month.
         */
        handleDblClick(event, moduleId, cycleType, monthIdx, originalKm) {
            const key = `${moduleId}-${cycleType}-${monthIdx}`;
            const cell = event.currentTarget;
            const span = cell.querySelector('.cell-value');
            const fleetType = '{{ fleet_param }}';
            const hierarchy = fleetType === 'csr' ? this.hierarchyCSR : this.hierarchyToshiba;
            const cycleIndex = hierarchy.indexOf(cycleType);

            if (this.interventions[key]) {
                // UNMARK: restore original values
                delete this.interventions[key];
                this.restoreCell(cell, span, originalKm);
                // Restore same-row cells to the right
                this.restoreSameRow(moduleId, cycleType, monthIdx);
                // Restore heir cells
                this.restoreHeirs(moduleId, cycleType, monthIdx, hierarchy, cycleIndex);
            } else {
                // MARK intervention
                this.interventions[key] = true;
                span.textContent = cycleType;
                // Apply base classes with cycle-specific colors (centered for intervention mark)
                const baseClasses = 'px-2 py-1.5 text-center border-b border-gray-100 cursor-pointer select-none whitespace-nowrap';
                const colors = this.cycleColors[cycleType];
                cell.className = `${baseClasses} ${colors?.bg || ''} ${colors?.text || ''} font-bold`;

                // Reset same-row cells to the right (accumulate from 0)
                this.resetSameRow(moduleId, cycleType, monthIdx);
                // Reset heir cycles (lower hierarchy) at this month
                this.resetHeirs(moduleId, cycleType, monthIdx, hierarchy, cycleIndex);
            }

            // Update summary footer counts
            this.updateSummary();
        },

        /**
         * Reset cells in the SAME row to the right of the intervention.
         * From monthIdx+1 onward: accumulate from 0 with avgKm.
         */
        resetSameRow(moduleId, cycleType, monthIdx) {
            const avgKm = parseInt('{{ avg_km }}');
            const cells = document.querySelectorAll(
                `td[data-module-id="${moduleId}"][data-cycle-type="${cycleType}"]`
            );

            let accumulated = 0;
            cells.forEach((c, idx) => {
                if (idx <= monthIdx) return; // Skip cells at or before intervention
                accumulated += avgKm;
                const s = c.querySelector('.cell-value');
                s.textContent = this.formatNumber(accumulated);
                // Check threshold for semaphore (read from data attribute, not nth-child which breaks with rowspan)
                const threshold = parseInt(c.dataset.threshold);
                // Start from base classes, then apply appropriate colors
                const baseClasses = 'px-2 py-1.5 text-right border-b border-gray-100 cursor-pointer select-none whitespace-nowrap';
                if (accumulated >= threshold) {
                    const badge = c.closest('tr').querySelector('span[class*="bg-"]');
                    if (badge) {
                        const bgClass = Array.from(badge.classList).find(cl => cl.startsWith('bg-'));
                        const textClass = Array.from(badge.classList).find(cl => cl.startsWith('text-'));
                        c.className = `${baseClasses} ${bgClass || ''} ${textClass || ''} font-semibold`;
                    }
                } else {
                    c.className = `${baseClasses} text-gray-600`;
                }
                c.dataset.overrideKm = String(accumulated);
            });
        },

        /**
         * Restore same-row cells to the right when unmarking intervention.
         */
        restoreSameRow(moduleId, cycleType, monthIdx) {
            const cells = document.querySelectorAll(
                `td[data-module-id="${moduleId}"][data-cycle-type="${cycleType}"]`
            );

            cells.forEach((c, idx) => {
                if (idx <= monthIdx) return;
                const origKm = parseInt(c.dataset.originalKm);
                const s = c.querySelector('.cell-value');

                s.textContent = this.formatNumber(origKm);
                delete c.dataset.overrideKm;
                // Restore original class from data attribute
                c.className = c.dataset.originalClass;
            });
        },

        /**
         * Reset lower-hierarchy cycle cells at the intervention month.
         * Sets them to "0" and recalculates subsequent months.
         */
        resetHeirs(moduleId, cycleType, monthIdx, hierarchy, cycleIndex) {
            if (cycleIndex < 0) return;
            const avgKm = parseInt('{{ avg_km }}');
            const baseClasses = 'px-2 py-1.5 text-right border-b border-gray-100 cursor-pointer select-none whitespace-nowrap';

            // All cycles below this one in the hierarchy
            for (let i = cycleIndex + 1; i < hierarchy.length; i++) {
                const heirCycle = hierarchy[i];
                // Find the row for this heir cycle
                const heirCells = document.querySelectorAll(
                    `td[data-module-id="${moduleId}"][data-cycle-type="${heirCycle}"]`
                );

                let accumulated = 0;
                heirCells.forEach((heirCell, idx) => {
                    const heirSpan = heirCell.querySelector('.cell-value');
                    if (idx < monthIdx) {
                        // Before intervention: keep original
                        return;
                    } else if (idx === monthIdx) {
                        // At intervention month: set to 0
                        heirSpan.textContent = '0';
                        accumulated = 0;
                        // Clear exceeded styling, apply base classes
                        heirCell.className = `${baseClasses} text-gray-600`;
                        heirCell.dataset.overrideKm = '0';
                    } else {
                        // After intervention: accumulate from 0
                        accumulated += avgKm;
                        heirSpan.textContent = this.formatNumber(accumulated);
                        // Check threshold (read from data attribute, not nth-child which breaks with rowspan)
                        const threshold = parseInt(heirCell.dataset.threshold);
                        if (accumulated >= threshold) {
                            // Re-apply exceeded color from the row
                            const badge = heirCell.closest('tr').querySelector('span[class*="bg-"]');
                            if (badge) {
                                const bgClass = Array.from(badge.classList).find(c => c.startsWith('bg-'));
                                const textClass = Array.from(badge.classList).find(c => c.startsWith('text-'));
                                heirCell.className = `${baseClasses} ${bgClass || ''} ${textClass || ''} font-semibold`;
                            }
                        } else {
                            heirCell.className = `${baseClasses} text-gray-600`;
                        }
                        heirCell.dataset.overrideKm = String(accumulated);
                    }
                });
            }
        },

        /**
         * Restore heir cells to their original values when unmarking.
         */
        restoreHeirs(moduleId, cycleType, monthIdx, hierarchy, cycleIndex) {
            if (cycleIndex < 0) return;

            for (let i = cycleIndex + 1; i < hierarchy.length; i++) {
                const heirCycle = hierarchy[i];
                const heirCells = document.querySelectorAll(
                    `td[data-module-id="${moduleId}"][data-cycle-type="${heirCycle}"]`
                );

                heirCells.forEach((heirCell, idx) => {
                    if (idx < monthIdx) return;
                    const origKm = parseInt(heirCell.dataset.originalKm);
                    const heirSpan = heirCell.querySelector('.cell-value');

                    heirSpan.textContent = this.formatNumber(origKm);
                    delete heirCell.dataset.overrideKm;
                    // Restore original class from data attribute
                    heirCell.className = heirCell.dataset.originalClass;
                });
            }
        },

        restoreCell(cell, span, originalKm) {
            span.textContent = this.formatNumber(originalKm);
            // Restore original class from data attribute
            cell.className = cell.dataset.originalClass;
        },

        /**
         * Recalculate the summary footer rows by counting intervention marks
         * in the grid body. An intervention is any cell whose .cell-value text
         * matches a cycle code (DA, PE, BA, AN, RG, RB).
         */
        updateSummary() {
            const fleetType = '{{ fleet_param }}';
            const hierarchy = fleetType === 'csr' ? this.hierarchyCSR : this.hierarchyToshiba;

            // Initialize counters: { "DA": [0,0,...], "PE": [...], ... }
            const counts = {};
            hierarchy.forEach(c => {
                counts[c] = new Array(this.totalMonths).fill(0);
            });
            const totals = new Array(this.totalMonths).fill(0);

            // Scan all data cells for intervention marks
            for (const [key, _] of Object.entries(this.interventions)) {
                // key format: "M01-DA-3"  (moduleId-cycleType-monthIdx)
                const parts = key.split('-');
                // moduleId may contain dashes (unlikely but safe): cycle is second-to-last, month is last
                const monthIdx = parseInt(parts[parts.length - 1]);
                const cycleType = parts[parts.length - 2];
                if (counts[cycleType] && monthIdx < this.totalMonths) {
                    counts[cycleType][monthIdx]++;
                    totals[monthIdx]++;
                }
            }

            // Update summary cells in the DOM
            hierarchy.forEach(cycle => {
                for (let m = 0; m < this.totalMonths; m++) {
                    const cell = document.querySelector(
                        `td[data-summary-cycle="${cycle}"][data-summary-month="${m}"] .summary-value`
                    );
                    if (cell) {
                        cell.textContent = counts[cycle][m];
                    }
                }
            });
            // Update totals row
            for (let m = 0; m < this.totalMonths; m++) {
                const cell = document.querySelector(
                    `td[data-summary-cycle="TOTAL"][data-summary-month="${m}"] .summary-value`
                );
                if (cell) {
                    cell.textContent = totals[m];
                }
            }
        },

        formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        },

        exportExcel() {
            // Build URL with current params + intervention data
            const params = new URLSearchParams(window.location.search);

            // Send interventions so Excel reflects what the user sees
            if (Object.keys(this.interventions).length > 0) {
                params.set('interventions', JSON.stringify(Object.keys(this.interventions)));
            }

            window.location.href = '{% url "fleet:projection_grid" %}export/?' + params.toString();
        }
    };
}
</script>
{% endblock %}
